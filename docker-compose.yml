services:
  # --- Serviços Olivia ---
  backend:
    build: .
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:backend-latest
    env_file:
      - .env
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /secrets/olivia-service-account-key.json
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS}:/secrets/olivia-service-account-key.json:ro

  frontend:
    build: ./frontend
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:frontend-latest
    depends_on:
      - backend

  olivia-api:
    image: ${ECR_REGISTRY}/olivia-api:latest
    env_file:
      - .env

  # --- Serviços n8n & Automação ---
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
      - olivia-api
      - n8n
      - waha

  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  n8n:
    image: n8nio/n8n
    restart: always
    environment:
      WEBHOOK_URL: https://n8n.olivinha.site
      N8N_HOST: host.docker.internal
      GENERIC_TIMEZONE: America/Sao_Paulo
      N8N_LOG_LEVEL: debug
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: "true"
      N8N_RUNNERS_ENABLED: "true"
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
    volumes:
      - n8n_data:/home/node/.n8n
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  waha:
    image: devlikeapro/waha:latest
    restart: always
    platform: linux/amd64
    environment:
      WHATSAPP_HOOK_URL: https://n8n.olivinha.site/webhook/webhook
      WHATSAPP_DEFAULT_ENGINE: GOWS
      WHATSAPP_HOOK_EVENTS: message
    volumes:
      - waha_sessions:/app/.sessions
      - waha_media:/app/.media
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

volumes:
  n8n_data:
  waha_sessions:
  waha_media:
