name: Build and Push to ECR

on:
  push:
    branches: [ main ]

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for checkout

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  AWS_ROLE_BUILD_ARN: "${{ vars.AWS_ROLE_BUILD_ARN }}"
  AWS_ROLE_DEPLOY_ARN: ${{ vars.AWS_ROLE_DEPLOY_ARN }}
  APP_DIR: ${{ vars.APP_DIR }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_BUILD_ARN }}
          role-session-name: github-actions-ecr-build
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          no-cache: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:backend-latest

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          no-cache: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:frontend-latest

  deploy-ec2:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_DEPLOY_ARN }}
          role-session-name: github-actions-ssm-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        run: |
          # Encode files to base64 to pass them easily via SSM
          DOCKER_COMPOSE_B64=$(base64 -w 0 docker-compose.yml)
          DEPLOY_SCRIPT_B64=$(base64 -w 0 scripts/deploy-ec2.sh)
          NGINX_CONF_B64=$(base64 -w 0 nginx/nginx.conf)
          SETUP_SSL_B64=$(base64 -w 0 scripts/setup-ssl.sh)

          # Busca o InstanceId dinamicamente pela tag (usando variáveis com fallback)
          TAG_KEY="${{ vars.DEPLOY_TAG_KEY || 'Project' }}"
          TAG_VALUE="${{ vars.DEPLOY_TAG_VALUE || 'Olivia' }}"

          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:$TAG_KEY,Values=$TAG_VALUE" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ]; then
            echo "Erro: Nenhuma instância rodando encontrada com a tag Project=Olivia"
            exit 1
          fi

          echo "Iniciando deploy via SSM na instância $INSTANCE_ID..."

          SSM_PARAMETERS=$(jq -cn \
            --arg app_dir "${{ env.APP_DIR }}" \
            --arg aws_region "${{ env.AWS_REGION }}" \
            --arg ecr_registry "${{ env.ECR_REGISTRY }}" \
            --arg ecr_repository "${{ env.ECR_REPOSITORY }}" \
            --arg docker_compose_b64 "$DOCKER_COMPOSE_B64" \
            --arg deploy_script_b64 "$DEPLOY_SCRIPT_B64" \
            --arg nginx_conf_b64 "$NGINX_CONF_B64" \
            --arg setup_ssl_b64 "$SETUP_SSL_B64" \
            --arg gcp_key "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" \
            --arg spreadsheet_id "${{ secrets.SPREADSHEET_ID }}" \
            --arg pluggy_client_id "${{ secrets.PLUGGY_CLIENT_ID }}" \
            --arg pluggy_client_secret "${{ secrets.PLUGGY_CLIENT_SECRET }}" \
            --arg admin_user "${{ secrets.ADMIN_USER }}" \
            --arg admin_pass "${{ secrets.ADMIN_PASS }}" \
            --arg jwt_secret "${{ secrets.JWT_SECRET }}" \
            --arg banks_json "${{ secrets.BANKS_JSON }}" \
            '{
              commands: [
                "mkdir -p \($app_dir)/scripts \($app_dir)/nginx",
                "echo \($docker_compose_b64 | @sh) | base64 -d > \($app_dir)/docker-compose.new",
                "echo \($deploy_script_b64 | @sh) | base64 -d > \($app_dir)/scripts/deploy-ec2.sh",
                "echo \($nginx_conf_b64 | @sh) | base64 -d > \($app_dir)/nginx/nginx.conf",
                "echo \($setup_ssl_b64 | @sh) | base64 -d > \($app_dir)/scripts/setup-ssl.sh",
                "chmod +x \($app_dir)/scripts/deploy-ec2.sh \($app_dir)/scripts/setup-ssl.sh",
                "export APP_DIR=\($app_dir | @sh)",
                "export AWS_REGION=\($aws_region | @sh)",
                "export ECR_REGISTRY=\($ecr_registry | @sh)",
                "export ECR_REPOSITORY=\($ecr_repository | @sh)",
                "export GCP_SERVICE_ACCOUNT_KEY=\($gcp_key | @sh)",
                "export SPREADSHEET_ID=\($spreadsheet_id | @sh)",
                "export PLUGGY_CLIENT_ID=\($pluggy_client_id | @sh)",
                "export PLUGGY_CLIENT_SECRET=\($pluggy_client_secret | @sh)",
                "export ADMIN_USER=\($admin_user | @sh)",
                "export ADMIN_PASS=\($admin_pass | @sh)",
                "export JWT_SECRET=\($jwt_secret | @sh)",
                "export BANKS_JSON=\($banks_json | @sh)",
                "\($app_dir)/scripts/deploy-ec2.sh"
              ]
            }')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Olivia Conciliation" \
            --parameters "$SSM_PARAMETERS" \
            --query "Command.CommandId" \
            --output text)

          echo "Comando enviado! ID: $COMMAND_ID"
          echo "Aguardando conclusão..."

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"

          # Verifica se o comando teve sucesso
          STATUS=$(aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "CommandInvocations[0].Status" \
            --output text)

          if [ "$STATUS" != "Success" ]; then
            echo "Erro no deploy! Status: $STATUS"
            aws ssm list-command-invocations \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --details \
              --query "CommandInvocations[0].CommandPlugins[0].Output" \
              --output text
            exit 1
          fi

          echo "Deploy finalizado com sucesso via SSM!"
